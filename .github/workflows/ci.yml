# =============================================================================
# CI Pipeline - Candidate Profile Intelligence Platform
# =============================================================================
#
# - Integrado nativamente con GitHub (sin configurar webhooks externos)
# - Secretos nativos para API keys
# - Jobs paralelos: FastAPI, Flask, Pipelines, React corren al mismo tiempo
# - Fail-fast: si un job falla, los demás se cancelan (ahorra minutos)
# - Cada job es independiente: un fix en Flask no requiere re-testear React
#
# =============================================================================

name: CI - Tests & Lint

on:
  push:
    branches: [main, develop, features, feature/*]
  pull_request:
    branches: [main, develop, features]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =========================================================================
  # Job 1: Tests de FastAPI (API pública)
  # =========================================================================
  test-fastapi:
    name: "FastAPI Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api-fastapi

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: services/api-fastapi/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r ../../pipelines/requirements.txt

      - name: Link shared volumes (pipelines & prompts)
        run: |
          ln -s ../../pipelines pipelines
          ln -s ../../prompts prompts

      - name: Set test environment variables
        run: |
          echo "DATABASE_URL=sqlite:///./test.db" >> $GITHUB_ENV
          echo "QDRANT_URL=http://localhost:6333" >> $GITHUB_ENV
          echo "COHERE_API_KEY=test-key" >> $GITHUB_ENV
          echo "MODEL_NAME=command-a-03-2025" >> $GITHUB_ENV
          echo "TEMPERATURE=0" >> $GITHUB_ENV
          echo "MAX_TOKENS=500" >> $GITHUB_ENV
          echo "LLM_TIMEOUT=30" >> $GITHUB_ENV
          echo "LANGCHAIN_TRACING_V2=false" >> $GITHUB_ENV
          echo "LANGCHAIN_API_KEY=test-key" >> $GITHUB_ENV

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-report=xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fastapi-coverage
          path: services/api-fastapi/coverage.xml

  # =========================================================================
  # Job 2: Tests de Flask (Admin API)
  # =========================================================================
  test-flask:
    name: "Flask Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/api-flask

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: services/api-flask/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r ../../pipelines/requirements.txt

      - name: Link shared volumes (pipelines)
        run: |
          ln -s ../../pipelines pipelines

      - name: Set test environment variables
        run: |
          echo "DATABASE_URL=sqlite:///./test.db" >> $GITHUB_ENV
          echo "QDRANT_URL=http://localhost:6333" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
          echo "COHERE_API_KEY=test-key" >> $GITHUB_ENV
          echo "EMBEDDING_MODEL=embed-multilingual-v3.0" >> $GITHUB_ENV
          echo "EMBEDDING_DIMENSION=1024" >> $GITHUB_ENV
          echo "EMBEDDING_DISTANCE=Cosine" >> $GITHUB_ENV

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-report=xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: flask-coverage
          path: services/api-flask/coverage.xml

  # =========================================================================
  # Job 3: Tests de Pipelines ETL
  # =========================================================================
  test-pipelines:
    name: "Pipeline Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pipelines

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: pipelines/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set test environment variables
        run: |
          echo "DATABASE_URL=sqlite:///./test.db" >> $GITHUB_ENV
          echo "QDRANT_URL=http://localhost:6333" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/0" >> $GITHUB_ENV
          echo "COHERE_API_KEY=test-key" >> $GITHUB_ENV
          echo "EMBEDDING_MODEL=embed-multilingual-v3.0" >> $GITHUB_ENV
          echo "EMBEDDING_DIMENSION=1024" >> $GITHUB_ENV
          echo "EMBEDDING_DISTANCE=Cosine" >> $GITHUB_ENV

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --tb=short --cov=etl --cov=utils --cov-report=term-missing --cov-report=xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pipelines-coverage
          path: pipelines/coverage.xml

  # =========================================================================
  # Job 4: Tests de React (Frontend)
  # =========================================================================
  test-react:
    name: "React Tests"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ui/react-app

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: ui/react-app/package-lock.json

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test
        env:
          VITE_API_URL: http://localhost:8000/v1

  # =========================================================================
  # Job 5: Build check de Rust Worker
  # =========================================================================
  check-rust:
    name: "Rust Worker Check"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/worker-rust

    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            services/worker-rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('services/worker-rust/Cargo.lock') }}

      - name: Check compilation
        run: cargo check

      - name: Run clippy (linter)
        run: cargo clippy -- -D warnings -A deprecated

  # =========================================================================
  # Job 6: Docker Build Validation
  # =========================================================================
  docker-build:
    name: "Docker Build Check"
    runs-on: ubuntu-latest
    needs: [test-fastapi, test-flask, test-pipelines, test-react]

    steps:
      - uses: actions/checkout@v4

      - name: Create dummy .env for validation
        run: |
          cat <<EOF > .env
          POSTGRES_USER=test
          POSTGRES_PASSWORD=test
          POSTGRES_DB=test
          DATABASE_URL=sqlite:///./test.db
          REDIS_URL=redis://localhost:6379/0
          QDRANT_URL=http://localhost:6333
          COHERE_API_KEY=test-key
          EMBEDDING_MODEL=embed-multilingual-v3.0
          EMBEDDING_DIMENSION=1024
          EMBEDDING_DISTANCE=Cosine
          VITE_API_URL=http://localhost:8000/v1
          EOF

      - name: Validate docker-compose
        run: docker compose -f infra/docker-compose.yml --env-file .env config --quiet

      - name: Build FastAPI image
        run: docker build -f infra/Dockerfile.fastapi -t test-fastapi .

      - name: Build Flask image
        run: docker build -f infra/Dockerfile.flask -t test-flask .
